<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enhanced Threat Detection</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/toxicity"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans antialiased">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-6">Enhanced Threat Detection and Contextual Analysis</h1>

    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8 border-4 border-gradient-to-r from-purple-400 to-pink-400">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 via-blue-600 to-green-600 bg-clip-text text-transparent mb-6 text-center border-b-4 border-gradient-to-r from-purple-400 to-pink-400 pb-4">
            🤖 TensorFlow Concepts Explained Through Restaurant Food Quality Detection 🍽️
        </h1>
        
        <!-- Feature Extraction Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold bg-gradient-to-r from-blue-600 to-cyan-500 bg-clip-text text-transparent mb-4 flex items-center">
                <span class="bg-gradient-to-r from-blue-400 to-cyan-400 rounded-full w-10 h-10 flex items-center justify-center text-white text-sm font-bold mr-3 shadow-lg">1</span>
                🔍 Feature Extraction - Like a Food Inspector's Checklist
            </h2>
            
            <div class="bg-gradient-to-br from-blue-100 via-cyan-50 to-blue-200 p-6 rounded-xl mb-4 border-2 border-blue-300 shadow-lg">
                <p class="text-gray-800 mb-4 text-lg font-medium">
                    Imagine you're a health inspector evaluating restaurants. You can't just look at a restaurant and immediately know if it's good or bad - you need to convert your observations into measurable numbers:
                </p>
                
                <div class="space-y-3">
                    <div class="flex items-start bg-white p-3 rounded-lg shadow-md border-l-4 border-green-400">
                        <span class="text-green-500 mr-3 mt-1 text-xl">🧽</span>
                        <span class="text-gray-700"><strong class="text-green-600">Count how many clean surfaces you see</strong> (like counting words in text)</span>
                    </div>
                    <div class="flex items-start bg-white p-3 rounded-lg shadow-md border-l-4 border-yellow-400">
                        <span class="text-yellow-500 mr-3 mt-1 text-xl">👃</span>
                        <span class="text-gray-700"><strong class="text-yellow-600">Rate the smell on a scale of 1-10</strong> (like weighting important keywords)</span>
                    </div>
                    <div class="flex items-start bg-white p-3 rounded-lg shadow-md border-l-4 border-red-400">
                        <span class="text-red-500 mr-3 mt-1 text-xl">🚩</span>
                        <span class="text-gray-700"><strong class="text-red-600">Check for specific red flags:</strong> expired food, dirty utensils, pests (like checking for threat indicators)</span>
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-gradient-to-r from-white to-blue-50 rounded-lg border-l-4 border-blue-400 shadow-md">
                    <p class="text-gray-700 font-medium">
                        So instead of <span class="text-red-600 font-bold bg-red-100 px-2 py-1 rounded">"this place smells weird and has flies,"</span> you get concrete numbers: 
                        <span class="font-mono bg-gradient-to-r from-purple-200 to-pink-200 px-3 py-2 rounded-lg font-bold text-purple-800 shadow-sm">[7 clean surfaces, smell score: 3/10, red flags: 2 violations]</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Linear Model Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold bg-gradient-to-r from-green-600 to-emerald-500 bg-clip-text text-transparent mb-4 flex items-center">
                <span class="bg-gradient-to-r from-green-400 to-emerald-400 rounded-full w-10 h-10 flex items-center justify-center text-white text-sm font-bold mr-3 shadow-lg">2</span>
                🧮 Linear Model (Logits) - Like Calculating a Restaurant Score
            </h2>
            
            <div class="bg-gradient-to-br from-green-100 via-emerald-50 to-green-200 p-6 rounded-xl mb-4 border-2 border-green-300 shadow-lg">
                <p class="text-gray-800 mb-4 text-lg font-medium">
                    Now you take those numbers and create a preliminary score using a formula you've learned from experience:
                </p>
                
                <div class="bg-gradient-to-br from-white to-green-50 p-6 rounded-xl border-2 border-green-200 shadow-lg space-y-3">
                    <div class="flex justify-between items-center border-b-2 border-green-200 pb-3 bg-gradient-to-r from-green-50 to-white p-3 rounded-lg">
                        <span class="text-gray-800 font-medium">🧽 Clean surfaces are worth 5 points each:</span>
                        <span class="font-mono text-green-600 font-bold text-lg bg-green-100 px-3 py-1 rounded-full">7 × 5 = 35 points</span>
                    </div>
                    <div class="flex justify-between items-center border-b-2 border-yellow-200 pb-3 bg-gradient-to-r from-yellow-50 to-white p-3 rounded-lg">
                        <span class="text-gray-800 font-medium">👃 Smell penalty:</span>
                        <span class="font-mono text-red-600 font-bold text-lg bg-red-100 px-3 py-1 rounded-full">3/10 × (-10) = -30 points</span>
                    </div>
                    <div class="flex justify-between items-center border-b-2 border-red-200 pb-3 bg-gradient-to-r from-red-50 to-white p-3 rounded-lg">
                        <span class="text-gray-800 font-medium">🚩 Violation penalty:</span>
                        <span class="font-mono text-red-600 font-bold text-lg bg-red-100 px-3 py-1 rounded-full">2 × (-20) = -40 points</span>
                    </div>
                    <div class="flex justify-between items-center border-b-2 border-blue-200 pb-3 bg-gradient-to-r from-blue-50 to-white p-3 rounded-lg">
                        <span class="text-gray-800 font-medium">⭐ Base score (starting assumption):</span>
                        <span class="font-mono text-blue-600 font-bold text-lg bg-blue-100 px-3 py-1 rounded-full">+10 points</span>
                    </div>
                    <div class="flex justify-between items-center font-bold text-xl pt-3 bg-gradient-to-r from-purple-100 to-pink-100 p-4 rounded-xl shadow-md border-2 border-purple-300">
                        <span class="text-gray-800">🎯 Total raw score:</span>
                        <span class="font-mono text-purple-700 bg-gradient-to-r from-purple-200 to-pink-200 px-4 py-2 rounded-full shadow-md">35 - 30 - 40 + 10 = -25</span>
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-gradient-to-r from-white to-green-50 rounded-lg border-l-4 border-green-400 shadow-md">
                    <p class="text-gray-700 font-medium">
                        This <span class="font-bold text-purple-700 bg-purple-200 px-2 py-1 rounded-full">-25</span> is your <strong class="text-green-600">"logit"</strong> - a raw score that could be any number, positive or negative.
                    </p>
                </div>
            </div>
        </div>

        <!-- Activation Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold bg-gradient-to-r from-purple-600 to-pink-500 bg-clip-text text-transparent mb-4 flex items-center">
                <span class="bg-gradient-to-r from-purple-400 to-pink-400 rounded-full w-10 h-10 flex items-center justify-center text-white text-sm font-bold mr-3 shadow-lg">3</span>
                📊 Activation (Sigmoid) - Like Converting to a Percentage Grade
            </h2>
            
            <div class="bg-gradient-to-br from-purple-100 via-pink-50 to-purple-200 p-6 rounded-xl mb-4 border-2 border-purple-300 shadow-lg">
                <p class="text-gray-800 mb-4 text-lg font-medium">
                    A raw score of -25 doesn't tell customers much. The sigmoid function is like converting that raw score into a familiar percentage:
                </p>
                
                <div class="bg-gradient-to-br from-white to-purple-50 p-6 rounded-xl border-2 border-purple-200 shadow-lg space-y-4">
                    <div class="flex justify-between items-center p-4 bg-gradient-to-r from-red-100 to-red-200 rounded-xl shadow-md border-2 border-red-300">
                        <span class="text-gray-800 font-medium flex items-center">
                            <span class="text-2xl mr-2">📉</span>
                            Raw score -25 becomes
                        </span>
                        <span class="font-bold text-red-700 bg-red-50 px-3 py-2 rounded-full shadow-sm">about 0.000001% chance (extremely low)</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-gradient-to-r from-yellow-100 to-yellow-200 rounded-xl shadow-md border-2 border-yellow-300">
                        <span class="text-gray-800 font-medium flex items-center">
                            <span class="text-2xl mr-2">📊</span>
                            Raw score 0 becomes
                        </span>
                        <span class="font-bold text-yellow-700 bg-yellow-50 px-3 py-2 rounded-full shadow-sm">50% chance (neutral)</span>
                    </div>
                    <div class="flex justify-between items-center p-4 bg-gradient-to-r from-green-100 to-green-200 rounded-xl shadow-md border-2 border-green-300">
                        <span class="text-gray-800 font-medium flex items-center">
                            <span class="text-2xl mr-2">📈</span>
                            Raw score +25 becomes
                        </span>
                        <span class="font-bold text-green-700 bg-green-50 px-3 py-2 rounded-full shadow-sm">99.999999% chance (extremely high)</span>
                    </div>
                </div>
                
                <div class="mt-4 p-4 bg-gradient-to-r from-white to-purple-50 rounded-lg border-l-4 border-purple-400 shadow-md">
                    <p class="text-gray-700 font-medium flex items-center">
                        <span class="text-2xl mr-2">🎓</span>
                        It's like converting test scores to letter grades - makes it easier to understand.
                    </p>
                </div>
            </div>
        </div>

        <!-- Decision Section -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold bg-gradient-to-r from-orange-600 to-red-500 bg-clip-text text-transparent mb-4 flex items-center">
                <span class="bg-gradient-to-r from-orange-400 to-red-400 rounded-full w-10 h-10 flex items-center justify-center text-white text-sm font-bold mr-3 shadow-lg">4</span>
                ⚖️ Decision - Like Pass or Fail
            </h2>
            
            <div class="bg-gradient-to-br from-orange-100 via-red-50 to-orange-200 p-6 rounded-xl mb-4 border-2 border-orange-300 shadow-lg">
                <p class="text-gray-800 mb-4 text-lg font-medium">
                    Finally, you compare the probabilities:
                </p>
                
                <div class="space-y-4">
                    <div class="flex items-start p-4 bg-gradient-to-r from-white to-red-50 rounded-xl border-2 border-red-200 shadow-md">
                        <span class="text-red-500 mr-3 mt-1 text-2xl">❌</span>
                        <span class="text-gray-800 font-medium">If there's a <span class="font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full">15% chance the restaurant is good</span> and <span class="font-bold text-red-600 bg-red-100 px-2 py-1 rounded-full">85% chance it's bad</span>, you choose <strong class="text-red-700 text-xl">"BAD"</strong></span>
                    </div>
                    <div class="flex items-start p-4 bg-gradient-to-r from-white to-green-50 rounded-xl border-2 border-green-200 shadow-md">
                        <span class="text-green-500 mr-3 mt-1 text-2xl">✅</span>
                        <span class="text-gray-800 font-medium">If there's a <span class="font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">75% chance it's good</span> and <span class="font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">25% chance it's bad</span>, you choose <strong class="text-green-700 text-xl">"GOOD"</strong></span>
                    </div>
                    <div class="flex items-start p-4 bg-gradient-to-r from-white to-blue-50 rounded-xl border-2 border-blue-200 shadow-md">
                        <span class="text-blue-500 mr-3 mt-1 text-2xl">🏆</span>
                        <span class="text-gray-800 font-medium"><strong class="text-blue-700">Whichever probability is higher wins</strong>, just like picking the restaurant with the better health grade</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Learning Process -->
        <div class="bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100 p-8 rounded-2xl border-4 border-gradient-to-r from-indigo-300 to-pink-300 shadow-2xl">
            <h3 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-4 flex items-center">
                <span class="text-3xl mr-3">🧠</span>
                How the System Learns
            </h3>
            <p class="text-gray-800 text-lg leading-relaxed font-medium bg-white p-4 rounded-lg shadow-md border-l-4 border-indigo-400">
                The whole system learns by seeing thousands of restaurants and their actual outcomes, gradually getting better at predicting which ones will make people sick.
            </p>
        </div>
    </div>

    <div id="sample-prompts" class="mb-4 text-gray-700"></div>
    <textarea id="inputText" class="block w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent mb-4" placeholder="Enter text to analyze…"></textarea>
    <button   id="triggerButton"  onclick="handleButtonClick()" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 mb-6">
      Analyze
    </button>
    <pre id="results" class="p-4 bg-white border border-gray-200 rounded whitespace-pre-wrap font-mono"></pre>
  </div>

    <div id="workingPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl border-4 border-blue-500 max-w-sm w-full mx-4 transform transition-all duration-300">
            <div class="flex flex-col items-center">
                <!-- Spinner -->
                <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-500 mb-6"></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Working...</h2>
                <p class="text-gray-600 text-center">Please wait while we process your request</p>
                <div class="mt-4 w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                </div>
            </div>
        </div>
    </div>
<hr/>

  <script>
    let testData = [];
    async function loadTestData() {
      const res = await fetch('/test_data.json');
      testData = (await res.json()).test_cases;
      renderSamplePrompts();
    }

    function renderSamplePrompts() {
      const c = document.getElementById('sample-prompts');
      c.innerHTML = '<strong class="text-gray-900">Try these:</strong>';
      testData.forEach(t => {
        const span = document.createElement('span');
        span.className = 'inline-block bg-gray-200 hover:bg-gray-300 text-sm text-gray-800 px-3 py-1 m-1 rounded border border-gray-300 cursor-pointer';
        span.textContent = t.text;
        span.onclick = () => document.getElementById('inputText').value = t.text;
        c.appendChild(span);
      });
    }

    const modelWeights = {
      weights: tf.tensor2d([
        [ 0.5, -0.3],   // word count weight
        [-0.1,  0.4],   // keyword score weight
        [ 0.2, -0.2],   // CWE flag weight
        [ 0.1, -0.1]    // MITRE flag weight
      ]),
      bias: tf.tensor1d([-0.1, 0.1])
    };

    function extractFeatures(text, hasCweFlag) {
      const words = text.toLowerCase().split(/\s+/);
      const wc_norm = words.length / 100;
      const keywords = ['attack','threat','harm','danger','kill','sql','ddos','injection','login'];
      const countRaw = words.filter(w => keywords.includes(w)).length;
      const kw_score = (countRaw * 2) / 5;
      const hasMitre = /TA\d{4}/i.test(text) ? 1 : 0;
      return tf.tensor2d([[wc_norm, kw_score, hasCweFlag, hasMitre]]);
    }

    function getContextualAnalysis(text) {
      const matches = text.toLowerCase().match(/attack|threat|harm|danger|kill|sql|ddos|login/g) || [];
      return {
        keyPhrases: matches.join(', ') || 'None',
        sentiment: matches.length ? 'Negative' : 'Neutral/Positive',
        wordCount: text.split(/\s+/).length
      };
    }

    async function predictThreat(inputTensor) {
      const logits = inputTensor.matMul(modelWeights.weights).add(modelWeights.bias);
      const [log0, log1] = await logits.data();
      const [p0, p1] = await tf.sigmoid(logits).data();
      const isThreat = p0 > p1;
      return { isThreat, pThreat: p0, pNonThreat: p1, logitThreat: log0, logitNon: log1 };
    }

    let toxModel;
    async function loadToxicity() { toxModel = await toxicity.load(); }

    async function analyzeText() {
      const txt = document.getElementById('inputText').value.trim();
      if (!txt) return document.getElementById('results').innerText = 'Please enter some text.';

      const meta = testData.find(t => t.text === txt);
      const hasCweFlag = meta && meta.labels.CWE && !['None','N/A'].includes(meta.labels.CWE) ? 1 : 0;

      const features = extractFeatures(txt, hasCweFlag);
      const fv = await features.data();

      const { isThreat, pThreat, pNonThreat, logitThreat, logitNon } = await predictThreat(features);
      const ctx = getContextualAnalysis(txt);

      let toxRes = 'Loading...';
      if (toxModel) {
        const preds = await toxModel.classify([txt]);
        const t = preds.find(p => p.label === 'toxicity');
        toxRes = t ? `${(t.results[0].probabilities[1]*100).toFixed(1)}%` : 'N/A';
      }

      let out = '';
      out += '--- Feature Vector ---\n';
      out += `WC_norm: ${fv[0].toFixed(3)}, KW_score: ${fv[1].toFixed(3)}, CWE_flag: ${fv[2]}, MITRE_flag: ${fv[3]}\n\n`;
      out += '--- Logits (raw) ---\n';
      out += `Threat: ${logitThreat.toFixed(3)}, Non-threat: ${logitNon.toFixed(3)}\n\n`;
      out += '--- Probabilities (sigmoid) ---\n';
      out += `P(threat): ${(pThreat*100).toFixed(1)}%, P(non-threat): ${(pNonThreat*100).toFixed(1)}%\n\n`;
      out += '--- Decision ---\n';
      out += isThreat ? 'Classified as: THREAT' : 'Classified as: NON-THREAT';
      out += ` (Confidence: ${(Math.max(pThreat, pNonThreat)*100).toFixed(1)}%)\n\n`;

      out += '--- Contextual Analysis ---\n';
      out += `Key Phrases: ${ctx.keyPhrases}\nSentiment: ${ctx.sentiment}\nWord Count: ${ctx.wordCount}\n\n`;
      out += `--- Toxicity ---\n${toxRes}\n\n`;

      if (meta) {
        out += '--- Metadata ---\n';
        out += `Type: ${meta.type}\nMITRE: ${meta.mitre_tactic || 'N/A'}\n`;
        out += `CWE: ${meta.labels.CWE}, Quality: ${meta.labels.Quality}, Code: ${meta.labels.Code}, Hardware: ${meta.labels.Hardware}\n`;
      }

      document.getElementById('results').innerText = out;
      return out
    }

       const triggerButton = document.getElementById('triggerButton');
        const workingPopup = document.getElementById('workingPopup');
        const resultDiv = document.getElementById('results');

     async function handleButtonClick() {
            // Disable button and show popup
            triggerButton.disabled = true;
            triggerButton.classList.add('opacity-50', 'cursor-not-allowed');
            workingPopup.classList.remove('hidden');
            
            // Update result div to show working status
            resultDiv.innerHTML = 'Working...';
            resultDiv.className = 'mt-6 p-4 bg-yellow-50 rounded-lg border-2 border-yellow-300 text-center text-yellow-700';

            try {
                // Call the separate work function and wait for it to complete
                const result = await analyzeText();
                
                // Hide popup
                workingPopup.classList.add('hidden');
                
                // Show success message
                resultDiv.innerHTML = result;
                resultDiv.className = 'mt-6 p-4 bg-green-50 rounded-lg border-2 border-green-300 text-center text-green-700 font-semibold';
                
            } catch (error) {
                // Hide popup and show error
                workingPopup.classList.add('hidden');
                resultDiv.innerHTML = '❌ Something went wrong!';
                resultDiv.className = 'mt-6 p-4 bg-red-50 rounded-lg border-2 border-red-300 text-center text-red-700';
            } finally {
                // Re-enable button
                triggerButton.disabled = false;
                triggerButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

    window.addEventListener('load', () => {
      loadTestData();
      loadToxicity();
    });
  </script>
  <hr/>


</body>
</html>
