<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Enhanced Threat Detection</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/toxicity"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans antialiased">
  <div class="max-w-3xl mx-auto p-6">
    <h1 class="text-3xl font-extrabold text-center text-gray-900 mb-6">Enhanced Threat Detection and Contextual Analysis</h1>

    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
      <strong class="block text-lg text-blue-700 mb-2">How it works:</strong>
      <ul class="list-disc list-inside space-y-1 text-gray-700">
        <li><strong>Feature Extraction</strong>: Converts text into numeric inputs—word count (normalized), weighted keyword score, CWE/ATT&CK flags from metadata.</li>
        <li><strong>Linear Model (Logits)</strong>: Applies weights & bias (<code class="bg-gray-100 px-1 rounded">logits = features·weights + bias</code>), computing raw scores.</li>
        <li><strong>Activation (Sigmoid)</strong>: Transforms logits into class probabilities (<code class="bg-gray-100 px-1 rounded">sigmoid(x) = 1/(1+e<sup>-x</sup>)</code>).</li>
        <li><strong>Decision</strong>: Compare P(threat) vs. P(non-threat); the higher wins.</li>
      </ul>
    </div>

    <div id="sample-prompts" class="mb-4 text-gray-700"></div>
    <textarea id="inputText" class="block w-full p-3 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-transparent mb-4" placeholder="Enter text to analyze…"></textarea>
    <button   id="triggerButton"  onclick="handleButtonClick()" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 mb-6">
      Analyze
    </button>
    <pre id="results" class="p-4 bg-white border border-gray-200 rounded whitespace-pre-wrap font-mono"></pre>
  </div>

    <div id="workingPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl border-4 border-blue-500 max-w-sm w-full mx-4 transform transition-all duration-300">
            <div class="flex flex-col items-center">
                <!-- Spinner -->
                <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-500 mb-6"></div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Working...</h2>
                <p class="text-gray-600 text-center">Please wait while we process your request</p>
                <div class="mt-4 w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full animate-pulse" style="width: 60%"></div>
                </div>
            </div>
        </div>
    </div>

  <script>
    let testData = [];
    async function loadTestData() {
      const res = await fetch('/test_data.json');
      testData = (await res.json()).test_cases;
      renderSamplePrompts();
    }

    function renderSamplePrompts() {
      const c = document.getElementById('sample-prompts');
      c.innerHTML = '<strong class="text-gray-900">Try these:</strong>';
      testData.forEach(t => {
        const span = document.createElement('span');
        span.className = 'inline-block bg-gray-200 hover:bg-gray-300 text-sm text-gray-800 px-3 py-1 m-1 rounded border border-gray-300 cursor-pointer';
        span.textContent = t.text;
        span.onclick = () => document.getElementById('inputText').value = t.text;
        c.appendChild(span);
      });
    }

    const modelWeights = {
      weights: tf.tensor2d([
        [ 0.5, -0.3],   // word count weight
        [-0.1,  0.4],   // keyword score weight
        [ 0.2, -0.2],   // CWE flag weight
        [ 0.1, -0.1]    // MITRE flag weight
      ]),
      bias: tf.tensor1d([-0.1, 0.1])
    };

    function extractFeatures(text, hasCweFlag) {
      const words = text.toLowerCase().split(/\s+/);
      const wc_norm = words.length / 100;
      const keywords = ['attack','threat','harm','danger','kill','sql','ddos','injection','login'];
      const countRaw = words.filter(w => keywords.includes(w)).length;
      const kw_score = (countRaw * 2) / 5;
      const hasMitre = /TA\d{4}/i.test(text) ? 1 : 0;
      return tf.tensor2d([[wc_norm, kw_score, hasCweFlag, hasMitre]]);
    }

    function getContextualAnalysis(text) {
      const matches = text.toLowerCase().match(/attack|threat|harm|danger|kill|sql|ddos|login/g) || [];
      return {
        keyPhrases: matches.join(', ') || 'None',
        sentiment: matches.length ? 'Negative' : 'Neutral/Positive',
        wordCount: text.split(/\s+/).length
      };
    }

    async function predictThreat(inputTensor) {
      const logits = inputTensor.matMul(modelWeights.weights).add(modelWeights.bias);
      const [log0, log1] = await logits.data();
      const [p0, p1] = await tf.sigmoid(logits).data();
      const isThreat = p0 > p1;
      return { isThreat, pThreat: p0, pNonThreat: p1, logitThreat: log0, logitNon: log1 };
    }

    let toxModel;
    async function loadToxicity() { toxModel = await toxicity.load(); }

    async function analyzeText() {
      const txt = document.getElementById('inputText').value.trim();
      if (!txt) return document.getElementById('results').innerText = 'Please enter some text.';

      const meta = testData.find(t => t.text === txt);
      const hasCweFlag = meta && meta.labels.CWE && !['None','N/A'].includes(meta.labels.CWE) ? 1 : 0;

      const features = extractFeatures(txt, hasCweFlag);
      const fv = await features.data();

      const { isThreat, pThreat, pNonThreat, logitThreat, logitNon } = await predictThreat(features);
      const ctx = getContextualAnalysis(txt);

      let toxRes = 'Loading...';
      if (toxModel) {
        const preds = await toxModel.classify([txt]);
        const t = preds.find(p => p.label === 'toxicity');
        toxRes = t ? `${(t.results[0].probabilities[1]*100).toFixed(1)}%` : 'N/A';
      }

      let out = '';
      out += '--- Feature Vector ---\n';
      out += `WC_norm: ${fv[0].toFixed(3)}, KW_score: ${fv[1].toFixed(3)}, CWE_flag: ${fv[2]}, MITRE_flag: ${fv[3]}\n\n`;
      out += '--- Logits (raw) ---\n';
      out += `Threat: ${logitThreat.toFixed(3)}, Non-threat: ${logitNon.toFixed(3)}\n\n`;
      out += '--- Probabilities (sigmoid) ---\n';
      out += `P(threat): ${(pThreat*100).toFixed(1)}%, P(non-threat): ${(pNonThreat*100).toFixed(1)}%\n\n`;
      out += '--- Decision ---\n';
      out += isThreat ? 'Classified as: THREAT' : 'Classified as: NON-THREAT';
      out += ` (Confidence: ${(Math.max(pThreat, pNonThreat)*100).toFixed(1)}%)\n\n`;

      out += '--- Contextual Analysis ---\n';
      out += `Key Phrases: ${ctx.keyPhrases}\nSentiment: ${ctx.sentiment}\nWord Count: ${ctx.wordCount}\n\n`;
      out += `--- Toxicity ---\n${toxRes}\n\n`;

      if (meta) {
        out += '--- Metadata ---\n';
        out += `Type: ${meta.type}\nMITRE: ${meta.mitre_tactic || 'N/A'}\n`;
        out += `CWE: ${meta.labels.CWE}, Quality: ${meta.labels.Quality}, Code: ${meta.labels.Code}, Hardware: ${meta.labels.Hardware}\n`;
      }

      document.getElementById('results').innerText = out;
      return out
    }

       const triggerButton = document.getElementById('triggerButton');
        const workingPopup = document.getElementById('workingPopup');
        const resultDiv = document.getElementById('results');

     async function handleButtonClick() {
            // Disable button and show popup
            triggerButton.disabled = true;
            triggerButton.classList.add('opacity-50', 'cursor-not-allowed');
            workingPopup.classList.remove('hidden');
            
            // Update result div to show working status
            resultDiv.innerHTML = 'Working...';
            resultDiv.className = 'mt-6 p-4 bg-yellow-50 rounded-lg border-2 border-yellow-300 text-center text-yellow-700';

            try {
                // Call the separate work function and wait for it to complete
                const result = await analyzeText();
                
                // Hide popup
                workingPopup.classList.add('hidden');
                
                // Show success message
                resultDiv.innerHTML = result;
                resultDiv.className = 'mt-6 p-4 bg-green-50 rounded-lg border-2 border-green-300 text-center text-green-700 font-semibold';
                
            } catch (error) {
                // Hide popup and show error
                workingPopup.classList.add('hidden');
                resultDiv.innerHTML = '❌ Something went wrong!';
                resultDiv.className = 'mt-6 p-4 bg-red-50 rounded-lg border-2 border-red-300 text-center text-red-700';
            } finally {
                // Re-enable button
                triggerButton.disabled = false;
                triggerButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

    window.addEventListener('load', () => {
      loadTestData();
      loadToxicity();
    });
  </script>
</body>
</html>
